name: Build UxPlay OpenWrt Package

on:
  push:
    branches: [ main, master, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - { target: x86, subtarget: 64, arch: x86_64, sdk_url: "https://downloads.openwrt.org/releases/24.10.4/targets/x86/64/openwrt-sdk-24.10.4-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst" }
          - { target: x86, subtarget: generic, arch: x86, sdk_url: "https://downloads.openwrt.org/releases/24.10.4/targets/x86/generic/openwrt-sdk-24.10.4-x86-generic_gcc-13.3.0_musl.Linux-x86_64.tar.zst" }
          - { target: armsr, subtarget: armv7, arch: armv7, sdk_url: "https://downloads.openwrt.org/releases/24.10.4/targets/armsr/armv7/openwrt-sdk-24.10.4-armsr-armv7_gcc-13.3.0_musl_eabi.Linux-x86_64.tar.zst" }
          - { target: armsr, subtarget: armv8, arch: armv8, sdk_url: "https://downloads.openwrt.org/releases/24.10.4/targets/armsr/armv8/openwrt-sdk-24.10.4-armsr-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.zst" }
          - { target: bcm27xx, subtarget: bcm2711, arch: rpi4, sdk_url: "https://downloads.openwrt.org/releases/24.10.4/targets/bcm27xx/bcm2711/openwrt-sdk-24.10.4-bcm27xx-bcm2711_gcc-13.3.0_musl.Linux-x86_64.tar.zst" }
          - { target: bcm27xx, subtarget: bcm2710, arch: rpi3, sdk_url: "https://downloads.openwrt.org/releases/24.10.4/targets/bcm27xx/bcm2710/openwrt-sdk-24.10.4-bcm27xx-bcm2710_gcc-13.3.0_musl.Linux-x86_64.tar.zst" }
          - { target: bcm27xx, subtarget: bcm2709, arch: rpi2, sdk_url: "https://downloads.openwrt.org/releases/24.10.4/targets/bcm27xx/bcm2709/openwrt-sdk-24.10.4-bcm27xx-bcm2709_gcc-13.3.0_musl_eabi.Linux-x86_64.tar.zst" }
          - { target: bcm27xx, subtarget: bcm2708, arch: rpi0, sdk_url: "https://downloads.openwrt.org/releases/24.10.4/targets/bcm27xx/bcm2708/openwrt-sdk-24.10.4-bcm27xx-bcm2708_gcc-13.3.0_musl_eabi.Linux-x86_64.tar.zst" }
          - { target: ramips, subtarget: mt7621, arch: mt7621, sdk_url: "https://downloads.openwrt.org/releases/24.10.4/targets/ramips/mt7621/openwrt-sdk-24.10.4-ramips-mt7621_gcc-13.3.0_musl.Linux-x86_64.tar.zst" }
          - { target: mediatek, subtarget: mt7622, arch: mt7622, sdk_url: "https://downloads.openwrt.org/releases/24.10.4/targets/mediatek/mt7622/openwrt-sdk-24.10.4-mediatek-mt7622_gcc-13.3.0_musl.Linux-x86_64.tar.zst" }
          - { target: mediatek, subtarget: mt7623, arch: mt7623, sdk_url: "https://downloads.openwrt.org/releases/24.10.4/targets/mediatek/mt7623/openwrt-sdk-24.10.4-mediatek-mt7623_gcc-13.3.0_musl.Linux-x86_64.tar.zst" }
          - { target: mediatek, subtarget: mt7629, arch: mt7629, sdk_url: "https://downloads.openwrt.org/releases/24.10.4/targets/mediatek/mt7629/openwrt-sdk-24.10.4-mediatek-mt7629_gcc-13.3.0_musl.Linux-x86_64.tar.zst" }
          - { target: ipq807x, subtarget: generic, arch: ipq807x, sdk_url: "https://downloads.openwrt.org/releases/24.10.4/targets/ipq807x/generic/openwrt-sdk-24.10.4-ipq807x-generic_gcc-13.3.0_musl.Linux-x86_64.tar.zst" }

    name: ${{ matrix.arch }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
          
      - name: Cache SDK
        uses: actions/cache@v4
        with:
          path: openwrt-sdk-*/
          key: sdk-${{ matrix.target }}-${{ matrix.subtarget }}-${{ hashFiles('.github/workflows/build.yml') }}
          
      - name: Download SDK
        run: |
          if ! ls -d openwrt-sdk-* &>/dev/null; then
            curl -L -o sdk.tar.zst "${{ matrix.sdk_url }}"
            tar -xf sdk.tar.zst
            rm sdk.tar.zst
          fi
          
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev zlib1g-dev \
            gawk git gettext libssl-dev python3 zstd
            
      - name: Prepare
        run: |
          SDK_DIR=$(ls -d openwrt-sdk-* | head -1)
          mkdir -p "$SDK_DIR/package/uxplay"
          rsync -a --exclude='.git' --exclude='openwrt-sdk-*' \
            --exclude='.github' --exclude='*.tar.zst' \
            . "$SDK_DIR/package/uxplay/"
          
          # Déterminer la version UxPlay à compiler
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            UXPLAY_VERSION="${{ github.ref_name }}"
          else
            UXPLAY_VERSION="master"
          fi
          
          # Injecter la version dans le Makefile
          sed -i "s/PKG_VERSION:=master/PKG_VERSION:=$UXPLAY_VERSION/" \
            "$SDK_DIR/package/uxplay/Makefile"
          
          echo "Building UxPlay version: $UXPLAY_VERSION"
          
      - name: Build
        run: |
          SDK_DIR=$(ls -d openwrt-sdk-* | head -1)
          cd "$SDK_DIR"
          
          # Update feeds pour obtenir les dépendances
          ./scripts/feeds update packages
          ./scripts/feeds install -a -p packages
          
          # Installer les dépendances spécifiques d'uxplay
          ./scripts/feeds install libplist openssl avahi avahi-libdns_sd gstreamer1 gst1-mod-app gst1-mod-video
          
          cat > .config << EOF
          CONFIG_TARGET_${{ matrix.target }}=y
          CONFIG_TARGET_${{ matrix.target }}_${{ matrix.subtarget }}=y
          CONFIG_PACKAGE_uxplay=m
          EOF
          yes "" | make oldconfig V=sc 2>&1 | tail -20
          
          # Test: compiler glib2 d'abord pour voir les erreurs détaillées
          make package/feeds/packages/glib2/compile V=s
          
          # Compiler uxplay (les dépendances seront compilées automatiquement)
          make package/uxplay/compile V=s
          
      - name: Package
        run: |
          SDK_DIR=$(ls -d openwrt-sdk-* | head -1)
          mkdir -p artifacts
          IPK=$(find "$SDK_DIR/bin/packages" -name "uxplay_*.ipk" | head -1)
          [ -f "$IPK" ] || exit 1
          cp "$IPK" "artifacts/uxplay_${{ matrix.arch }}.ipk"
          
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: uxplay-${{ matrix.arch }}
          path: artifacts/
          retention-days: 30
          
      - name: Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*.ipk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary:
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        
      - name: Summary
        run: |
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Arch | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          for dir in uxplay-*; do
            if [ -d "$dir" ] && [ -f "$dir/uxplay_"*.ipk ]; then
              echo "| ${dir#uxplay-} | ✅ |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ${dir#uxplay-} | ❌ |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          find . -name "*.ipk" -exec ls -lh {} \; | awk '{print $9, $5}' >> $GITHUB_STEP_SUMMARY
