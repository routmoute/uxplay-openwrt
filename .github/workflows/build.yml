name: Build UxPlay OpenWrt Package

on:
  push:
    branches: [ main, master, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      uxplay_version:
        description: 'UxPlay version to build (default: 1.73)'
        required: false
        default: '1.73'

env:
  UXPLAY_VERSION: ${{ github.event.inputs.uxplay_version || '1.73' }}

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Architecture: x86_64
          - target: x86
            subtarget: 64
            arch_display: "x86_64"
            
          # Architecture: x86 32-bit
          - target: x86
            subtarget: generic
            arch_display: "x86"
            
          # ARM Systemready 32-bit (armv7)
          - target: armsr
            subtarget: armv7
            arch_display: "ARM Systemready armv7"
            
          # ARM Systemready 64-bit (armv8)
          - target: armsr
            subtarget: armv8
            arch_display: "ARM Systemready armv8"
            
          # Raspberry Pi 4/5 (bcm27xx)
          - target: bcm27xx
            subtarget: bcm2711
            arch_display: "Raspberry Pi 4/5 (ARMv8)"
            
          # Raspberry Pi 3 (bcm27xx)
          - target: bcm27xx
            subtarget: bcm2710
            arch_display: "Raspberry Pi 3 (ARMv8)"
            
          # Raspberry Pi 2
          - target: bcm27xx
            subtarget: bcm2709
            arch_display: "Raspberry Pi 2 (ARMv7)"
            
          # Raspberry Pi Zero/Zero W
          - target: bcm27xx
            subtarget: bcm2708
            arch_display: "Raspberry Pi Zero/Zero W (ARMv6)"
            
          # MediaTek (TP-Link, Xiaomi, etc.) - mt7621 (32-bit)
          - target: ramips
            subtarget: mt7621
            arch_display: "MediaTek MT7621 (MIPS)"
            
          # MediaTek - mt7622 (ARM)
          - target: mediatek
            subtarget: mt7622
            arch_display: "MediaTek MT7622 (ARM)"
            
          # MediaTek - mt7623 (ARM)
          - target: mediatek
            subtarget: mt7623
            arch_display: "MediaTek MT7623 (ARM)"
            
          # MediaTek - mt7629 (ARM)
          - target: mediatek
            subtarget: mt7629
            arch_display: "MediaTek MT7629 (ARM)"
            
          # Qualcomm - ipq807x (ARM64) - High-end routers
          - target: ipq807x
            subtarget: generic
            arch_display: "Qualcomm IPQ807x (ARM64)"


    name: Build for ${{ matrix.arch_display }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        
      - name: Set up environment
        run: |
          echo "SDK_URL=$(curl -s https://api.github.com/repos/openwrt/openwrt/releases | grep -oP '"browser_download_url": "\K[^"]*SDK[^"]*23\.05[^"]*${{ matrix.target }}-${{ matrix.subtarget }}[^"]*\.tar\.xz' | head -1)" >> $GITHUB_ENV
          
      - name: Download OpenWrt SDK
        run: |
          # Known SDK URLs
          case "${{ matrix.target }}-${{ matrix.subtarget }}" in
            x86-64)
              SDK_URL="https://downloads.openwrt.org/releases/23.05.0/targets/x86/64/openwrt-sdk-23.05.0-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
              ;;
            x86-generic)
              SDK_URL="https://downloads.openwrt.org/releases/23.05.0/targets/x86/generic/openwrt-sdk-23.05.0-x86-generic_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
              ;;
            armsr-armv7)
              SDK_URL="https://downloads.openwrt.org/releases/23.05.0/targets/armsr/armv7/openwrt-sdk-23.05.0-armsr-armv7_gcc-12.3.0_musl_eabi.Linux-x86_64.tar.xz"
              ;;
            armsr-armv8)
              SDK_URL="https://downloads.openwrt.org/releases/23.05.0/targets/armsr/armv8/openwrt-sdk-23.05.0-armsr-armv8_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
              ;;
            bcm27xx-bcm2711)
              SDK_URL="https://downloads.openwrt.org/releases/23.05.0/targets/bcm27xx/bcm2711/openwrt-sdk-23.05.0-bcm27xx-bcm2711_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
              ;;
            bcm27xx-bcm2709)
              SDK_URL="https://downloads.openwrt.org/releases/23.05.0/targets/bcm27xx/bcm2709/openwrt-sdk-23.05.0-bcm27xx-bcm2709_gcc-12.3.0_musl_eabi.Linux-x86_64.tar.xz"
              ;;
            bcm27xx-bcm2710)
              SDK_URL="https://downloads.openwrt.org/releases/23.05.0/targets/bcm27xx/bcm2710/openwrt-sdk-23.05.0-bcm27xx-bcm2710_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
              ;;
            bcm27xx-bcm2708)
              SDK_URL="https://downloads.openwrt.org/releases/23.05.0/targets/bcm27xx/bcm2708/openwrt-sdk-23.05.0-bcm27xx-bcm2708_gcc-12.3.0_musl_eabi.Linux-x86_64.tar.xz"
              ;;
            ramips-mt7621)
              SDK_URL="https://downloads.openwrt.org/releases/23.05.0/targets/ramips/mt7621/openwrt-sdk-23.05.0-ramips-mt7621_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
              ;;
            mediatek-mt7622)
              SDK_URL="https://downloads.openwrt.org/releases/23.05.0/targets/mediatek/mt7622/openwrt-sdk-23.05.0-mediatek-mt7622_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
              ;;
            mediatek-mt7623)
              SDK_URL="https://downloads.openwrt.org/releases/23.05.0/targets/mediatek/mt7623/openwrt-sdk-23.05.0-mediatek-mt7623_gcc-12.3.0_musl_eabi.Linux-x86_64.tar.xz"
              ;;
            mediatek-mt7629)
              SDK_URL="https://downloads.openwrt.org/releases/23.05.0/targets/mediatek/mt7629/openwrt-sdk-23.05.0-mediatek-mt7629_gcc-12.3.0_musl_eabi.Linux-x86_64.tar.xz"
              ;;
            ipq807x-generic)
              SDK_URL="https://downloads.openwrt.org/releases/23.05.0/targets/ipq807x/generic/openwrt-sdk-23.05.0-ipq807x-generic_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
              ;;

            *)
              echo "Architecture non supportÃ©e: ${{ matrix.target }}-${{ matrix.subtarget }}"
              exit 1
              ;;
          esac
          
          echo "SDK_URL=$SDK_URL" >> $GITHUB_ENV
          echo "TÃ©lÃ©chargement: $SDK_URL"
          
      - name: Cache OpenWrt SDK
        uses: actions/cache@v5
        with:
          path: openwrt-sdk-*/
          key: sdk-${{ matrix.target }}-${{ matrix.subtarget }}-${{ hashFiles('.github/workflows/build.yml') }}
          restore-keys: |
            sdk-${{ matrix.target }}-${{ matrix.subtarget }}-
            
      - name: Download and extract SDK
        run: |
          if ! ls -d openwrt-sdk-* &>/dev/null; then
            echo "Downloading SDK from: $SDK_URL"
            curl -L -o sdk.tar.xz "$SDK_URL" || wget -q "$SDK_URL" -O sdk.tar.xz
            tar -xf sdk.tar.xz
            rm sdk.tar.xz
          fi
          
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev zlib1g-dev \
            gawk git unzip gettext libssl-dev python3 python3-pip
            
      - name: Prepare package
        run: |
          SDK_DIR=$(ls -d openwrt-sdk-* | head -1)
          mkdir -p "$SDK_DIR/package/uxplay"
          
          # Copy only needed files, exclude .git and build artifacts
          rsync -a --exclude='.git' --exclude='openwrt-sdk-*' \
            --exclude='.github' --exclude='*.tar.xz' \
            --exclude='build.log' --exclude='artifacts' \
            . "$SDK_DIR/package/uxplay/"
          
          # Verify the Makefile is in place
          test -f "$SDK_DIR/package/uxplay/Makefile" || {
            echo "ERROR: Makefile not found in package/uxplay"
            exit 1
          }
          
      - name: Update feeds
        run: |
          SDK_DIR=$(ls -d openwrt-sdk-* | head -1)
          cd "$SDK_DIR"
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
      - name: Remove pymysql to avoid circular dependency
        run: |
          SDK_DIR=$(ls -d openwrt-sdk-* | head -1)
          # Simply delete the problematic pymysql package
          rm -rf "$SDK_DIR/feeds/packages/lang/python/pymysql"
          
      - name: Configure build
        run: |
          SDK_DIR=$(ls -d openwrt-sdk-* | head -1)
          cd "$SDK_DIR"
          echo "CONFIG_PACKAGE_uxplay=m" > .config
          make defconfig
          
      - name: Build package
        run: |
          SDK_DIR=$(ls -d openwrt-sdk-* | head -1)
          cd "$SDK_DIR"
          
          make package/index
          make package/uxplay/compile V=s
          
      - name: Create package artifact
        run: |
          SDK_DIR=$(ls -d openwrt-sdk-* | head -1)
          mkdir -p artifacts
          
          IPK=$(find "$SDK_DIR/bin/packages" -name "uxplay_*.ipk" -type f | head -1)
          
          if [ ! -f "$IPK" ]; then
            echo "ERROR: .ipk file not found"
            exit 1
          fi
          
          cp "$IPK" artifacts/
          ARCH_FILE="${{ matrix.arch_display }}"
          ARCH_FILE=${ARCH_FILE// /_}
          mv "artifacts/$(basename "$IPK")" "artifacts/uxplay_${{ env.UXPLAY_VERSION }}-1_${ARCH_FILE}.ipk"
          echo "âœ… Build successful"
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: uxplay-${{ matrix.arch_display }}
          path: artifacts/
          retention-days: 30
          
      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*.ipk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Comment on PR
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ Build failed for ${{ matrix.arch_display }}\n\nPlease check the workflow logs.'
            })

  summary:
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        
      - name: Create summary
        run: |
          echo "## ðŸ“¦ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          
          for dir in uxplay-*; do
            if [ -d "$dir" ] && [ -f "$dir/uxplay_"*.ipk ]; then
              echo "| ${dir#uxplay-} | âœ… Success |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ${dir#uxplay-} | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find . -name "uxplay_*.ipk" -type f -exec ls -lh {} \; | awk '{print $9, "(" $5 ")"}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
